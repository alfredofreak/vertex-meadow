<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title id="title">Vertex Meadow Exporter</title>
    <script src="jquery-2.1.3.min.js" type="text/javascript"></script>
  </head>
  <body>
    <h1>Vertex Meadow Exporter</h1>

    <h2>How to use it</h2>
    <p>
    This tool allows you to export a standalone version of your Vertex Meadow
    level that can be uploaded to your own web server or hosted on somewhere
    like gamejolt or itch.io.
    </p>

    <p>
    To use this tool you first need to click the share button in the editor.
    Then copy the ID of your share (the numbers and letters at the end of the share URL
    after the "?l=" bit) and paste it into the box below.
    For example if your URL is http://www.vertexmeadow.xyz/player.html?l=ca1ff7d54db0480c7818
    then you'd paste ca1ff7d54db0480c7818 into the box below.
    </p>
    
    <p>
    Then click the Export button and wait for the files to export (this may take a little while
    depending on your internet connection speed).
    They will appear as links below. There should be 9 files:
    <ul>
        <li>floor.png</li>
        <li>floor_detail.png</li>
        <li>ceiling.png</li>
        <li>ceiling_detail.png</li>
        <li>settings.lua</li>
        <li>amulet.js</li>
        <li>data.pak</li>
        <li>player.html</li>
        <li>jquery-2.1.3.min.js</li>
    </ul>
    </p>
    <p>
    Once the links have appeared click them to download the files.
    </p>
    <p>
    Note that the height map is stored in the alpha channel, so the images might look
    a bit faded, or even completely transparent, if you open them in an image program.
    </p>
    <p>
    Once all the files are downloaded, rename the file data.pak to data.zip and
    replace the files floor.png, floor_detail.png, ceiling.png,
    ceiling_detail.png and settings.lua in the zip with the ones you downloaded.
    Then rename it back to data.pak.
    Make sure your zip program doesn't put the files into a directory
    in the zip archive. All the files should be at the top level of the
    zip archive.
    Also make sure your zip program doesn't add any encryption.
    </p>
    <p>
    Now upload your new data.pak along with amulet.js, player.html and jquery-2.1.3.min.js
    to your own web site, or itch.io or whatever. The URL for your game should point
    to player.html with no parameters. You can rename this file to index.html if you like.
    </p>

    <p>
    Feel free to do whatever you like with your creation, including selling it.
    The code in amulet.js is from another engine I wrote called Amulet.
    You can find the source code for Amulet here: <a href="http://www.amulet.xyz">http://www.amulet.xyz</a>.
    </p>

    <p>
    Note that this export method requires the files be accessed from a web server. They won't
    work if you just open player.html from your local file system. For a completely offline
    build, a native build of Amulet will be made available at <a href="http://www.amulet.xyz">
    http://www.amulet.xyz</a>. This will work with the same data files, but will be a native
    app that will run on Windows, Mac or Linux. I expect native builds to be available by the end of 2015.
    Poke me on <a href="https://twitter.com/muclorty">twitter</a> if they're not.
    </p>

    <h2>Export:</h2>
    <label>Share ID:</label><input id="gistid" type="text" width="40"></input>
    <br>
    <button id="export_button">Export</button>
    <br>
    <div id="downloads"></div>
    <script type='text/javascript'>

function load_image(name, res) {
    var filename64 = name + ".png64";
    var filename = name + ".png";
    function append_link(data) {
        $("#downloads").append('<a href="data:image/png;base64,' + data + '" download="' + filename + '">' + filename + '</a><br>');
    }
    if (res.files[filename64].truncated) {
        $.get(res.files[filename64].raw_url, function(data) {
            append_link(data);
        });
    } else {
        append_link(res.files[filename64].content);
    }
}

function load_settings(res) {
    var filename = "settings.lua"
    $("#downloads").append('<a href="' + res.files[filename].raw_url + '" download="' + filename + '">' + filename + '</a><br>');
}

function load_gitfile(file) {
    var url = "https://raw.githubusercontent.com/ianmaclarty/vertex-meadow/gh-pages/" + file;
    $("#downloads").append('<a href="' + url + '" download="' + file + '">' + file + '</a><br>');
}

function load_gist(id) {
    console.log("loading gist " + id);
    var url = 'https://api.github.com/gists/'+id;
    $.get(url, function(data) {
        console.log("received gist");
        var res = JSON.parse(data);
        $("#downloads").empty();
        load_image("floor", res);
        load_image("floor_detail", res);
        load_image("ceiling", res);
        load_image("ceiling_detail", res);
        load_settings(res);
        load_gitfile("amulet.js");
        load_gitfile("data.pak");
        load_gitfile("player.html");
        load_gitfile("jquery-2.1.3.min.js");
    }, "text").fail(function() {
        alert('failed to load level with id: ' + id)
    });
}

$("#export_button").click(function() {
    load_gist($("#gistid").val());
});

    </script>
  </body>
</html>
